# ML Module - Бизнес-классификатор

## Общее описание

ML модуль предназначен для автоматической классификации бизнес-вопросов по категориям. Модуль использует машинное обучение для определения категории вопроса пользователя, что позволяет системе предоставлять более релевантные ответы и улучшать пользовательский опыт.

## Структура модуля

```
backend/ml/
├── __init__.py                    # Инициализация пакета
├── models/                        # Модели машинного обучения
│   ├── __init__.py
│   ├── business_classifier.py     # Основной класс классификатора
│   └── business_classifier.pkl    # Обученная модель (создается после обучения)
├── services/                      # Сервисы для использования моделей
│   ├── __init__.py
│   └── classifier_service.py      # Сервис для работы с классификатором
├── datasets/                      # Датасеты для обучения
│   ├── __init__.py
│   └── dataset_generation.py      # Генерация и хранение обучающих данных
├── train_classifier.py            # Скрипт для обучения модели
└── Readme.md                      # Документация (этот файл)
```

## Компоненты модуля

### 1. `models/business_classifier.py` - Классификатор бизнес-вопросов

**Назначение:** Основной класс для классификации бизнес-вопросов по категориям.

**Основные возможности:**
- Классификация текстовых вопросов по 6 категориям
- Извлечение признаков из текста
- Обучение модели на датасете
- Сохранение и загрузка обученной модели

**Класс:** `EnhancedBusinessClassifier`

**Методы:**

- `__init__()` - Инициализация классификатора
  - Создает RandomForestClassifier с оптимизированными параметрами
  - Определяет 6 категорий: `marketing`, `finance`, `legal`, `management`, `sales`, `general`
  - Инициализирует словари ключевых слов для каждой категории

- `preprocess_text(text: str) -> str` - Предобработка текста
  - Приводит текст к нижнему регистру
  - Удаляет специальные символы (кроме букв, цифр, пробелов, #, +)
  - Нормализует пробелы

- `calculate_keyword_features(text: str) -> np.array` - Извлечение признаков ключевых слов
  - Для каждой категории вычисляет:
    - **Presence**: количество найденных ключевых слов
    - **TF Score**: частота встречаемости ключевых слов в тексте
    - **Normalized Score**: нормализованная частота (относительно длины текста)
  - Возвращает массив из 18 признаков (6 категорий × 3 типа признаков)

- `extract_text_features(text: str) -> np.array` - Извлечение текстовых метрик
  - Длина текста
  - Количество слов
  - Количество предложений
  - Средняя длина слова
  - Доля длинных слов (>6 символов)
  - Возвращает массив из 5 признаков

- `get_text_embeddings(texts)` - Получение семантических эмбеддингов
  - **Примечание:** В текущей версии закомментировано использование SentenceTransformer
  - Предназначено для получения векторных представлений текста
  - Может быть активировано для улучшения точности классификации

- `train(dataset: List[Dict]) -> Tuple[float, float]` - Обучение модели
  - Принимает датасет в формате `[{"text": "...", "label": "..."}, ...]`
  - Извлекает признаки из всех текстов
  - Разделяет данные на обучающую (85%) и тестовую (15%) выборки
  - Обучает RandomForestClassifier
  - Выводит метрики точности и детальный отчет по категориям
  - Возвращает точность на обучающей и тестовой выборках

- `predict(text: str) -> Tuple[str, Dict[str, float]]` - Предсказание категории
  - Принимает текст вопроса
  - Извлекает все признаки (эмбеддинги, ключевые слова, метрики)
  - Возвращает предсказанную категорию и вероятности для всех категорий

- `save_model(path: str)` - Сохранение модели
  - Сохраняет классификатор, метки и словари ключевых слов в файл .pkl

- `load_model(path: str)` - Загрузка модели
  - Загружает сохраненную модель из файла .pkl

**Категории классификации:**
1. **marketing** - Маркетинг, реклама, продвижение, брендинг, SMM, SEO
2. **finance** - Финансы, бюджет, налоги, инвестиции, отчетность
3. **legal** - Юриспруденция, договоры, правовые вопросы, лицензирование
4. **management** - Управление, команда, персонал, процессы, KPI
5. **sales** - Продажи, клиенты, сделки, CRM, коммерческие предложения
6. **general** - Общие бизнес-вопросы, стартапы, стратегия, развитие

**Ключевые слова по категориям:**
- Каждая категория имеет расширенный словарь ключевых слов (10-12 слов/фраз)
- Ключевые слова используются для извлечения признаков и улучшения классификации

---

### 2. `services/classifier_service.py` - Сервис классификатора

**Назначение:** Высокоуровневый сервис для использования классификатора в приложении.

**Класс:** `BusinessClassifierService`

**Методы:**

- `__init__(model_path: str = None)` - Инициализация сервиса
  - Автоматически определяет путь к модели (`backend/ml/models/business_classifier.pkl`)
  - Загружает модель при инициализации
  - Если модель не найдена, использует фиктивный классификатор на основе ключевых слов

- `load_model()` - Загрузка обученной модели
  - Проверяет существование файла модели
  - Загружает модель через `EnhancedBusinessClassifier.load_model()`
  - Обрабатывает ошибки загрузки

- `predict_category(text: str) -> Tuple[str, Dict[str, float]]` - Предсказание категории
  - Основной метод для классификации текста
  - Если модель загружена - использует ML классификатор
  - Если модель не загружена - использует фиктивный классификатор на ключевых словах
  - Возвращает категорию и вероятности

- `_dummy_prediction(text: str) -> Tuple[str, Dict[str, float]]` - Фиктивное предсказание
  - Используется когда модель не загружена
  - Простая логика на основе ключевых слов
  - Возвращает категорию с вероятностью 0.8 и 'general' с вероятностью 0.2

- `is_ready() -> bool` - Проверка готовности классификатора
  - Возвращает `True` если модель загружена, `False` иначе

**Использование:**
```python
from backend.ml.services.classifier_service import BusinessClassifierService

# Инициализация сервиса
classifier_service = BusinessClassifierService()

# Классификация текста
category, probabilities = classifier_service.predict_category("Как продвигать бизнес в Instagram")
print(f"Категория: {category}")
print(f"Вероятности: {probabilities}")
```

---

### 3. `datasets/dataset_generation.py` - Генерация датасета

**Назначение:** Хранение обучающего датасета для классификатора.

**Содержимое:**
- `business_dataset` - список из 600 примеров бизнес-вопросов
- Распределение по категориям:
  - **marketing**: 100 примеров
  - **finance**: 100 примеров
  - **legal**: 100 примеров
  - **management**: 100 примеров
  - **sales**: 100 примеров
  - **general**: 100 примеров

**Формат данных:**
```python
[
    {"text": "Как продвигать бизнес в соцсетях", "label": "marketing"},
    {"text": "Составление бизнес-плана для инвесторов", "label": "finance"},
    ...
]
```

**Характеристики датасета:**
- Все примеры на русском языке
- Вопросы охватывают различные аспекты бизнеса
- Примеры включают как общие, так и специфические вопросы
- Сбалансированное распределение по категориям

**Расширение датасета:**
Для улучшения точности классификации можно добавлять новые примеры в соответствующие категории.

---

### 4. `train_classifier.py` - Скрипт обучения

**Назначение:** Скрипт для обучения модели классификатора на датасете.

**Функции:**

- `train_classifier()` - Основная функция обучения
  - Загружает датасет из `dataset_generation.py`
  - Выводит статистику датасета (размер, распределение по категориям)
  - Создает экземпляр `EnhancedBusinessClassifier`
  - Обучает модель на датасете
  - Сохраняет модель в `models/business_classifier.pkl`
  - Тестирует модель на примерах
  - Выводит метрики точности

**Использование:**
```bash
# Из корневой директории проекта
python -m backend.ml.train_classifier
```

**Выходные данные:**
- Обученная модель сохраняется в `backend/ml/models/business_classifier.pkl`
- Выводится статистика обучения:
  - Размер датасета
  - Распределение по категориям
  - Точность на обучающей выборке
  - Точность на тестовой выборке
  - Детальный отчет по категориям (precision, recall, f1-score)
  - Результаты тестирования на примерах

---

## Быстрый старт

### 1. Обучение модели

Перед использованием классификатора необходимо обучить модель:

```bash
# Из корневой директории проекта
python -m backend.ml.train_classifier
```

После успешного обучения модель будет сохранена в `backend/ml/models/business_classifier.pkl`.

### 2. Использование в коде

```python
from backend.ml.services.classifier_service import BusinessClassifierService

# Создание сервиса (автоматически загружает модель)
classifier = BusinessClassifierService()

# Проверка готовности
if classifier.is_ready():
    # Классификация текста
    category, probabilities = classifier.predict_category(
        "Как увеличить продажи через Instagram"
    )
    print(f"Категория: {category}")
    print(f"Вероятности: {probabilities}")
else:
    print("Модель не загружена. Запустите train_classifier.py")
```

### 3. Интеграция в API

Классификатор может быть использован в API endpoints для автоматической категоризации вопросов пользователей.

---

## Технические детали

### Алгоритм классификации

**Модель:** RandomForestClassifier (scikit-learn)

**Параметры модели:**
- `n_estimators=100` - количество деревьев
- `max_depth=20` - максимальная глубина дерева
- `min_samples_split=3` - минимальное количество образцов для разделения узла
- `min_samples_leaf=1` - минимальное количество образцов в листе
- `random_state=42` - для воспроизводимости результатов

### Признаки (Features)

Модель использует комбинацию признаков:

1. **Семантические эмбеддинги** (закомментировано в текущей версии)
   - Векторные представления текста через SentenceTransformer
   - Размерность: 384 (для модели `paraphrase-multilingual-MiniLM-L12-v2`)

2. **Признаки ключевых слов** (18 признаков)
   - Для каждой из 6 категорий:
     - Presence: количество найденных ключевых слов
     - TF Score: частота встречаемости
     - Normalized Score: нормализованная частота

3. **Текстовые метрики** (5 признаков)
   - Длина текста
   - Количество слов
   - Количество предложений
   - Средняя длина слова
   - Доля длинных слов

**Общая размерность признаков:** 18 + 5 = 23 (без эмбеддингов)

### Разделение данных

- **Обучающая выборка:** 85% данных
- **Тестовая выборка:** 15% данных
- **Стратификация:** по категориям (для сохранения пропорций)

### Метрики оценки

- **Accuracy** - общая точность классификации
- **Classification Report** - детальные метрики по категориям:
  - Precision (точность)
  - Recall (полнота)
  - F1-score (гармоническое среднее)
  - Support (количество примеров)

---

## Зависимости

### Основные библиотеки

```python
# Машинное обучение
scikit-learn>=1.0.0        # RandomForestClassifier, метрики
joblib>=1.0.0               # Сохранение/загрузка моделей

# Обработка данных
pandas>=1.3.0               # Работа с датасетами
numpy>=1.21.0                # Математические операции

# Обработка текста (опционально)
# sentence-transformers>=2.0.0  # Для семантических эмбеддингов
```

### Установка зависимостей

```bash
pip install scikit-learn joblib pandas numpy
# Опционально для улучшения точности:
# pip install sentence-transformers
```

---

## Процесс работы

### Обучение модели

1. Загрузка датасета из `datasets/dataset_generation.py`
2. Предобработка текстов
3. Извлечение признаков:
   - Ключевые слова
   - Текстовые метрики
   - (Опционально) Семантические эмбеддинги
4. Объединение признаков
5. Разделение на train/test
6. Обучение RandomForestClassifier
7. Оценка качества
8. Сохранение модели

### Предсказание

1. Предобработка входного текста
2. Извлечение признаков (те же, что при обучении)
3. Объединение признаков
4. Предсказание через обученную модель
5. Возврат категории и вероятностей

---

## Примеры использования

### Пример 1: Базовое использование

```python
from backend.ml.services.classifier_service import BusinessClassifierService

classifier = BusinessClassifierService()
category, probs = classifier.predict_category("Как составить бизнес-план")
print(f"Категория: {category}")  # finance
```

### Пример 2: Получение вероятностей

```python
category, probabilities = classifier.predict_category(
    "Стратегия продвижения в социальных сетях"
)
print(f"Категория: {category}")  # marketing
print(f"Все вероятности:")
for cat, prob in probabilities.items():
    print(f"  {cat}: {prob:.2%}")
```

### Пример 3: Обучение новой модели

```python
from backend.ml.models.business_classifier import EnhancedBusinessClassifier
from backend.ml.datasets.dataset_generation import business_dataset

# Создание и обучение
classifier = EnhancedBusinessClassifier()
train_score, test_score = classifier.train(business_dataset)

# Сохранение
classifier.save_model("models/my_classifier.pkl")
```

---

## Важные замечания

1. **Модель должна быть обучена перед использованием**
   - Если модель не найдена, используется фиктивный классификатор
   - Фиктивный классификатор менее точен, но позволяет тестировать систему

2. **Семантические эмбеддинги**
   - В текущей версии использование SentenceTransformer закомментировано
   - Для активации раскомментируйте соответствующий код в `business_classifier.py`
   - Это улучшит точность, но увеличит время предсказания и требования к памяти

3. **Расширение датасета**
   - Для улучшения точности добавляйте новые примеры в `dataset_generation.py`
   - Сохраняйте баланс между категориями
   - После добавления данных переобучите модель

4. **Производительность**
   - RandomForestClassifier быстр в предсказании
   - Обучение может занять несколько минут на больших датасетах
   - Модель занимает ~1-2 МБ в памяти

---

## Настройка и оптимизация

### Улучшение точности

1. **Активация эмбеддингов:**
   ```python
   # В business_classifier.py раскомментируйте:
   from sentence_transformers import SentenceTransformer
   self.embedder = SentenceTransformer('sentence-transformers/paraphrase-multilingual-MiniLM-L12-v2')
   ```

2. **Расширение датасета:**
   - Добавьте больше примеров в `dataset_generation.py`
   - Особенно для категорий с низкой точностью

3. **Настройка параметров модели:**
   ```python
   self.classifier = RandomForestClassifier(
       n_estimators=200,      # Больше деревьев
       max_depth=30,          # Глубже деревья
       min_samples_split=2,  # Меньше ограничений
       ...
   )
   ```

### Оптимизация производительности

1. **Уменьшение признаков:**
   - Используйте только ключевые слова без эмбеддингов
   - Упростите текстовые метрики

2. **Уменьшение параметров модели:**
   ```python
   self.classifier = RandomForestClassifier(
       n_estimators=50,       # Меньше деревьев
       max_depth=10,          # Меньше глубина
       ...
   )
   ```

---

## Логи и отладка

### Вывод информации при обучении

Скрипт `train_classifier.py` выводит:
- Размер датасета
- Распределение по категориям
- Прогресс извлечения признаков
- Размерность признаков
- Точность на train/test
- Детальный отчет по категориям
- Результаты тестирования

### Вывод информации при использовании

`BusinessClassifierService` выводит:
- Статус загрузки модели
- Предсказания с вероятностями
- Ошибки при загрузке/предсказании

